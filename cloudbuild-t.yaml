# cloudbuild.yaml
logsBucket: gs://chatverse-cloud-build-logs

substitutions:
  _SERVER_IMAGE: "asia-south1-docker.pkg.dev/chatverse-475306/chatverse-docker-repo/server:latest"
  _CLIENT_IMAGE: "asia-south1-docker.pkg.dev/chatverse-475306/chatverse-docker-repo/client:latest"
  _CLUSTER_NAME: "chatverse-cluster"
  _CLUSTER_ZONE: "asia-south1"
  _NAMESPACE: "default"
  _PROJECT_ID: "chatverse-475306"
steps:
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk:latest"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        set -euo pipefail

        echo "ðŸ” Getting credentials for cluster ${_CLUSTER_NAME}..."
        gcloud container clusters get-credentials "${_CLUSTER_NAME}" --zone "${_CLUSTER_ZONE}" --project "${_PROJECT_ID}"

        echo "----- ðŸ“¥ Downloading secrets from bucket -----"
        gsutil cp "gs://${_BUCKET}/secrets/server-secret.yaml" k8ns/server-secret.yaml || echo "âš ï¸ Server secret not found in bucket"

        gsutil cp "gs://${_BUCKET}/secrets/client-secret.yaml" k8ns/client-secret.yaml || echo "âš ï¸ Client secret not found in bucket"

        echo "----- ðŸ§¾ Applying Secrets (if they exist) -----"
        if [ -f "k8ns/server-secret.yaml" ]; then
          kubectl apply -f k8ns/server-secret.yaml -n "${_NAMESPACE}"
        fi
        if [ -f "k8ns/client-secret.yaml" ]; then
          kubectl apply -f k8ns/client-secret.yaml -n "${_NAMESPACE}"
        fi

        echo "----- ðŸš€ SERVER DEPLOYMENT -----"
        if kubectl get deploy chatverse-server -n "${_NAMESPACE}" >/dev/null 2>&1; then
          echo "Updating server image to ${_SERVER_IMAGE}"
          kubectl set image deployment/chatverse-server server="${_SERVER_IMAGE}" -n "${_NAMESPACE}"
          kubectl rollout status deployment/chatverse-server -n "${_NAMESPACE}" --timeout=300s
        else
          echo "Server deployment not found â€” applying manifest..."
          kubectl apply -f k8ns/server-deployment.yaml -n "${_NAMESPACE}"
          kubectl rollout status deployment/chatverse-server -n "${_NAMESPACE}" --timeout=300s
        fi

        echo "----- ðŸš€ CLIENT DEPLOYMENT -----"
        if kubectl get deploy chatverse-client -n "${_NAMESPACE}" >/dev/null 2>&1; then
          echo "Updating client image to ${_CLIENT_IMAGE}"
          kubectl set image deployment/chatverse-client client="${_CLIENT_IMAGE}" -n "${_NAMESPACE}"
          kubectl rollout status deployment/chatverse-client -n "${_NAMESPACE}" --timeout=300s
        else
          echo "Client deployment not found â€” applying manifest..."
          kubectl apply -f k8ns/client-deployment.yaml -n "${_NAMESPACE}"
          kubectl rollout status deployment/chatverse-client -n "${_NAMESPACE}" --timeout=300s
        fi

        echo "âœ… All deployments successfully rolled out."
timeout: 1200s